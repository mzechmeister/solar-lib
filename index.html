<html>
<head>
<title>Solar spectrum library</title>
<script src='https://cdn.plot.ly/plotly-2.14.0.min.js'></script>
<script src='zoom_pan.js'></script>

<style>
#wluser:not(:checked) ~ * {
    color: gray;
}

#lamcen:focus, #lamwid:focus {
    color: unset;
}

#wlopt label {
    display: inline-block;
    width: 5em;
    height: 1.5em;
    border: 1px solid black;
    margin: 2px;
    text-align: center;
    opacity: 0.5;
}

[name="lamtip"] {
    display: none;
}

#wlopt input:checked+label {
    box-shadow: none;
    opacity: unset;
}

#wlopt label:hover {
    box-shadow: 0 0 4px #03F;
    opacity: 0.7;
}
</style>
</head>

<h1 style="text-align: center">IAG solar spatial resolved spectrum library</h1>

<div id="spectrum" style="height: 400px" oncontextmenu="return false"></div>
<div style="text-align: center">
<input type="radio" id="wluser" name="lamtip"><label for="wluser'" title="user" style="display: none">user</label>
<label for=""><i>λ</i><sub>central</sub> [Å]</label> <input id="lamcen" type="number" value="6000" onchange="redo(1)">
<label for="">width [px]</label> <input id="lamwid" type="number" value="6500" step="100" onchange="redo(1)"></div>

<div id="wlopt" style="text-align: center"></div>
<div id="slider" style="height: 120px" oncontextmenu="return false"></div>

<script>
sliderdiv = document.getElementById('slider');

colors = [
    '#1f77b4',  // muted blue
    '#ff7f0e',  // safety orange
    '#2ca02c',  // cooked asparagus green
    '#d62728',  // brick red
    '#9467bd',  // muted purple
    '#8c564b',  // chestnut brown
    '#e377c2',  // raspberry yogurt pink
    '#7f7f7f',  // middle gray
    '#bcbd22',  // curry yellow-green
    '#17becf'   // blue-teal
]

lines = [[5472.15, "Mn 574"], [5891.42, "NaD<sub>2</sub>"], [5897.496, "NaD<sub>1</sub>"],
         [6564.5, "Hα"],
         [7000, "700"], [8000, "800"]
]

for (const [i, li] of lines.entries()) {
    wlopt.innerHTML += '<input type="radio" id="l'+li[0]+'" name="lamtip" onclick="lamcen.value='+li[0]+'; redo()"><label for="l'+li[0]+'" title="'+li[0]+'" style="background-color:'+colors[i+1]+'">'+li[1]+'</label>'
}

wlmin = 4200   // [Angstrom]
dwl = 0.001


async function readatlas(wlstart, wlstop) {
    // pl xi=NaN, '<head -10000 ../solar-atlas/data/solar_atlas_V1' us 0:(dx=$1-xi, xi=$1,dx), xi=NaN, '<tail -10000 ../solar-atlas/data/solar_atlas_V1' us 0:(dx=$1-xi, xi=$1,dx), xi=NaN, '../solar-atlas/data/solar_atlas_V1' every 100 us 0:(dx=$1-xi, xi=$1,dx/100), xi=NaN, '<head -1697300 ../solar-atlas/data/solar_atlas_V1 |tail -300' us 0:(dx=$1-xi, xi=$1,dx)
    // !awk 'NR==1 {print NR, 1e8/$1, $0}' ../solar-atlas/data/solar_atlas_V1
    //      1 24700.1 04048.5689318294      0.9130446175    0.0021814581
    // !awk 'NR==2360282,NR==2360285 {print NR, 1e8/$1, $0}' ../solar-atlas/data/solar_atlas_V1
    // 2360282 15810 06325.1082636120  1.0005637998    0.1049125418
    // 2360283 15810 06325.1097705158  1.0004275880    0.1043522432
    // 2360284 15779.7 06337.2573958258        0.9670763636    0.1037384272
    // 2360285 15779.7 06337.2589084838        0.9678726141    0.1030937359
    // pl '<head -2360400 ../solar-atlas/data/solar_atlas_V1 |tail -400' us 0:(1e8/$1)
    // data have gap pl '../solar-atlas/data/solar_atlas_V1' us (1e8/$1):2 every ::2360000::2361000

    wnstart = 1e8 / wlstart
    wnstop = 1e8 / wlstop
    dwn = (1e8/6325.1097705158 - 1e8/4048.5689318294) / (2360283-1)
    wnref = 1e8/4048.5689318294
    linegapsize = 8045 // (1e8/6337.2573958258 - 1e8/6325.1097705158)/dwn // == 8045.9999922165225
    linegapstart = 2360283
    linegapstop = linegapstart + linegapsize
    linebytes = 43
    linestart = parseInt((wnstart-wnref) / dwn)
    linestop = parseInt((wnstop-wnref) / dwn)
    if (linestart > linegapstart) linestart = (linestart < linegapstop) ? linegapstop : linestart - linegapsize
    if (linestop > linegapstart) linestop = (linestop < linegapstop) ? linegapstart : linestop - linegapsize

    var headers = {Range: `bytes=${linebytes*linestart}-${linebytes*linestop-1}`};
    var response = await fetch('../solar-atlas/data/solar_atlas_V1', {headers});
    buf = await response.text()
    d = buf.slice(0, -1).split(/\t|\n/).map(parseFloat)
    x = d.filter((a,i) => i%3==0)
    y = d.filter((a,i) => i%3==1)

    info.innerHTML = '../solar-atlas/data/solar_atlas_V1'

    return [x, y]
}

async function readfits(file, start, stop) {
    var headers = {Range: `bytes=${2880+8*start}-${2880+8*stop-1}`};
    var response = await fetch(file, {headers});

    // swap endian
    buf = await response.arrayBuffer()
    d = new Float64Array(new Int8Array(buf.slice()).reverse().buffer).reverse()

    info.innerHTML = file

    return d
}

async function redo(user=false) {
    if (user) wluser.checked = true;
    console.log(lamcen.value)

    icen = parseInt((lamcen.valueAsNumber - wlmin) / dwl)
    ileft = icen - lamwid.valueAsNumber/2
    iright = icen + lamwid.valueAsNumber/2
    wl = [...Array(lamwid.valueAsNumber)].map((_,i) => wlmin + (ileft+i)*dwl)

    datas = []
    mus = ['0.20', '0.30', '0.80', '0.90'];
    mus = ['0.20', '0.30', '0.35', '0.40', '0.50', '0.60', '0.70', '0.80', '0.90', '0.95', '0.97', '0.98', '0.99', '1.00'];
    for (mu of mus)
        datas.push({'mu': mu, y: await readfits('data/solarspectrum_mu'+mu+'.fits', 3800001 + ileft, 3800001 + iright)});

    A = await readatlas(wl[0], wl.slice(-1))

    plotspec(wl, datas, A)
}

axisfmt = {showline: true, mirror: 'ticks', ticklen: 8, ticks: 'inside',
           minor: {ticks: 'inside', ticklen: 4}
}

function plotspec(wl, d, A) {
    traces = d.map(dk => {return {x: wl, y: dk.y, line: {width: 1}, name: dk.mu}})

    traces.push({x: A[0], y: A[1], line: {color: 'black'}, name: 'integrated'})

    Plotly.newPlot('spectrum', traces, {
        margin: {t: 10, b: 40},
        hovermode:'closest',
        xaxis: {title: 'vacuum wavelength <i>λ</i> [Å]', ...axisfmt},
        yaxis: {title: 'normalised flux', ...axisfmt},
        separators: '.',   // no comma as thousand separator
        legend: {title: {text: 'μ'}},
    }, {responsive: true});

    x0 = lamcen.valueAsNumber - dwl*lamwid.valueAsNumber/2
    x1 = lamcen.valueAsNumber + dwl*lamwid.valueAsNumber/2

    // selected range color
    let i = [...document.querySelectorAll('[name="lamtip"]')].indexOf(document.querySelector('[name="lamtip"]:checked'))
    markcol = colors[i * (i>0)]

    Plotly.update('slider', {x: [[x0, x0], [x1, x1]],  line: [{color: markcol}, {color: markcol}]}, {}, [2, 3]);
}

async function plotslider() {
    var response = await fetch('data/solar_4_trim');
    buf = await response.text()
    var d = buf.split(/\t|\n/).map(parseFloat),
        x = d.filter((a,i) => i%3==0),
        y1 = d.filter((a,i) => i%3==1),
        y2 = d.filter((a,i) => i%3==2)

    Plotly.newPlot(slider,
       [{x: x, y: y2, name: "", line: {width: 1, color: '#bbb'}, showlegend: false},
        {x: x, y: y1, name: "", line: {width: 1, color: '#bbb'}, showlegend: false, fill: 'tonexty'},
        {x: [], y: [0, 1.2], name: "user range", line: {width: 2}, showlegend: false},
        {x: [], y: [0, 1.2], name: "user range", line: {width: 2}, showlegend: false, fill: 'tonextx'},
        ...lines.map((d, i) => {return {x: [d[0], d[0]], y: [0, 1.2], name: d[1], line: {width: 1, color: colors[i+1]}}}),
       ],
       {margin: {t: 5, b: 20, l: 30, r: 10},
        xaxis: {...axisfmt},
        yaxis: {range: [0, 1.2], ...axisfmt},
        separators: '.',
        showlegend: false,
       },
       {responsive: true,
        displayModeBar: false})
       .then(attach);
}

function attach() {
    zoompan('#slider')
    var timer = null
    document.querySelector("#slider .nsewdrag").addEventListener('click', function(evt) {
        // capture a potential double click with a short delay
        if (event.detail === 1) {
            timer = setTimeout(() => {
                var bb = evt.target.getBoundingClientRect();
                lamcen.value = sliderdiv._fullLayout.xaxis.p2d(evt.clientX - bb.left);
                redo(1);
            }, 200)
        }
        else {   // double click
            clearTimeout(timer)
        }
    });
};

redo().then(zoompan)
plotslider()

</script>

Ellwarth+ (in prep.)
<br>See also:
<ul>
<li><a href="data/">data</a> (fits files)</li>
<li><a href="https://www.astro.physik.uni-goettingen.de/research/flux_atlas">IAG solar flux atlas</a></li>
<li><a href="https://github.com/mzechmeister/solar-lib">https://github.com/mzechmeister/solar-lib</a></li>
</ul>
<div id="info" style="font-family: monospace; text-align: right;"></div>
Tips:
<ul>
<li>Click on the slider to manually set a new wavelength.</li>
<li>Press '0' to set the lower y-range to zero. More short cuts are listed here <a href="https://github.com/mzechmeister/csvplotter">here</a>.</li>
</ul>

</html>
